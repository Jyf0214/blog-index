name: Log Script and Random String Generator

on:
  schedule:
    - cron: '0 4 * * 5'  # 每周五 UTC 4点（即 UTC+8 的中午12点）
  workflow_dispatch:  # 支持手动触发工作流

jobs:
  log_script:
    runs-on: ubuntu-latest
    env:
      EMAIL: ${{ secrets.EMAIL }}
      PASSWORD: ${{ secrets.PASSWORD }}
      SMTP_USER: ${{ secrets.SMTP_USER }}
      SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
      TOEMAIL: ${{ secrets.TOEMAIL }}
      MAIL_SUBJECT: ${{ secrets.MAIL_SUBJECT }}
      ACCOUNTS: ${{ secrets.ACCOUNTS }}
      FROMMAIL: ${{ secrets.FROMMAIL }}
      # 如果有其他需要的环境变量，可以继续在这里添加

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}  # 使用 GitHub 提供的默认 Token

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'

      - name: Install dependencies
        run: |
          pip install requests  # 安装依赖包

      - name: Generate Random String and Save to TXT
        run: |
          python src/random_string.py

      - name: Run log script
        run: |
          python src/closure.py  # 运行日志脚本

      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Update generated files"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}