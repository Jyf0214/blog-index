name: Rclone-Unified Parallel Video Compression (Corrected & Final)

on:
  workflow_dispatch:

env:
  REMOTE_DIR: ${{ github.run_id }}
  WORKFLOW_RUN_ID: ${{ github.run_id }}

jobs:
  # 任务1：分割视频，解密脚本，并分别缓存产物
  split_and_cache:
    runs-on: ubuntu-latest
    outputs:
      matrix_payload: ${{ steps.split.outputs.matrix_array }}
      original_filename: ${{ steps.split.outputs.original_filename }}
    steps:
      - name: Install FFmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Clone veiled-journeys repository
        env:
          PAT: ${{ secrets.GITCODE_TOKEN }} 
        run: git clone https://Jyf0214:${PAT}@gitcode.com/Jyf0214/veiled-journeys.git

      - name: Install Python requirements
        working-directory: ./veiled-journeys
        run: pip install -r requirements.txt

      - name: Start Session (Decrypt veiled-journeys)
        working-directory: ./veiled-journeys
        env:
          Jyf0214_PASSWORD: ${{ secrets.Jyf0214_PASSWORD }}
        run: python main.py start

      - name: Download Original Video (Using Encrypted Script)
        run: |
          python webdav_sync.py cloud-to-local ./files /teracloud/kemono_uploads/aibishoujo/part_1
          python webdav_sync.py cloud-to-local ./host_videos /teracloud/videos/wallpaper
          bash 隐写术加密.sh
          python webdav_sync.py local-to-cloud ./output_parts /lanzoui/视频壁纸
      - name: Cleanup Session (Remove Decrypted Files)
        if: always()
        working-directory: ./veiled-journeys
        run: python main.py cleanup

