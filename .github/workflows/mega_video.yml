name: Optimized Video Processor

on:
  workflow_dispatch:

jobs:
  video-processing:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: 3.9

      - name: Setup Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ffmpeg \
            mediainfo \  # ç”¨äºè§†é¢‘åˆ†æ
            htop \       # èµ„æºç›‘æ§
            python3-pip

      - name: Clone Repository
        env:
          PAT: ${{ secrets.PAT }}
        run: |
          git clone https://x-access-token:${PAT}@github.com/Jyf0214/veiled-journeys.git

      - name: Create Processor Script
        run: |
          cat > veiled-journeys/video_processor.sh <<'EOL'
          #!/bin/bash
          # èµ„æºé™åˆ¶å‚æ•°
          MAX_THREADS=$(( $(nproc) - 1 ))  # ä¿ç•™1ä¸ªæ ¸å¿ƒ
          MEM_LIMIT="6G"                  # é¢„ç•™1Gç»™ç³»ç»Ÿ

          echo "ğŸ–¥ï¸ ç³»ç»Ÿèµ„æº | å¯ç”¨æ ¸å¿ƒ: $(nproc) | æ€»å†…å­˜: $(free -h | awk '/Mem/{print $2}')"

          # æ–‡ä»¶æ£€æµ‹
          video_file=$(find . -maxdepth 1 -type \( -iname "*.mp4" -o -iname "*.mkv" -o -iname "*.avi" \) -print -quit)
          subtitle_file=$(find . -maxdepth 1 -type -iname "*.srt" -print -quit)

          # æ™ºèƒ½åˆ†è¾¨ç‡æ£€æµ‹
          resolution=$(mediainfo --Inform="Video;%Width%x%Height%" "$video_file")
          echo "ğŸ“º æ£€æµ‹åˆ°è§†é¢‘åˆ†è¾¨ç‡: $resolution"

          # åŠ¨æ€å‚æ•°è°ƒæ•´
          case $resolution in
              3840x2160)  # 4K
                  preset="medium"
                  crf=23
                  rc_lookahead=30
                  ;;
              1920x1080)  # 1080p
                  preset="fast"
                  crf=22
                  rc_lookahead=40
                  ;;
              1280x720)   # 720p
                  preset="faster"
                  crf=21
                  rc_lookahead=50
                  ;;
              *)
                  preset="veryfast"
                  crf=20
                  rc_lookahead=60
                  ;;
          esac

          # è½¬ç å‘½ä»¤
          ffmpeg -v warning -i "$video_file" \
            -vf "subtitles='$subtitle_file':force_style='Fontname=Microsoft YaHei,Fontsize=24'" \
            -c:v libx264 \
            -preset $preset \
            -crf $crf \
            -profile:v baseline \
            -level 4.0 \
            -x264-params \
              "nal-hrd=cbr:rc-lookahead=$rc_lookahead:threads=$MAX_THREADS" \
            -filter_threads $((MAX_THREADS/2)) \
            -threads $MAX_THREADS \
            -movflags +faststart \
            -c:a aac -b:a 128k \
            -max_muxing_queue_size 1024 \
            -y "output_$(date +%s).mp4"

          echo "âœ… å¤„ç†å®Œæˆ | è¾“å‡ºæ–‡ä»¶: output*.mp4"
          EOL

          chmod +x veiled-journeys/video_processor.sh
          cd veiled-journeys
          python koofr_download_and_delete.py

      - name: Process Video
        run: |
          cd veiled-journeys
          /usr/bin/time -v ./video_processor.sh 2> processing_stats.log
          echo "ğŸ“Š èµ„æºä½¿ç”¨ç»Ÿè®¡ï¼š"
          cat processing_stats.log | grep -E 'Maximum resident set size|Elapsed (wall clock) time'

      - name: Upload Results
        run: |
          cd veiled-journeys
          python koofr_upload.py