name: Run OpenList + Kemono Downloader (Manual Access Window & Data Persistence)

on:
  workflow_dispatch:

jobs:
  openlist-kemono:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Prepare TERM env
        run: echo "TERM=xterm-256color" >> $GITHUB_ENV

      - name: Install OpenList
        run: |
          echo "Installing OpenList..."
          curl -fsSL "https://docs.openlist.team/v3.sh" -o v3.sh
          sudo bash v3.sh install /opt/openlist
          # webdavclient3 is often needed by OpenList or its components, or by the downloader
          pip install webdavclient3

      - name: Clone private repository (veiled-journeys)
        env:
          PAT: ${{ secrets.PAT }}
        run: |
          echo "Cloning private repository veiled-journeys..."
          git clone https://x-access-token:${PAT}@github.com/Jyf0214/veiled-journeys.git

      - name: Configure OpenList and Restore Data
        id: configure-openlist-data
        run: |
          echo "Configuring OpenList and restoring data..."
          cd /opt/openlist
          echo "Setting OpenList admin password..."
          sudo ./openlist admin set "${{ secrets.OPENLIST_PASSWORD }}"
          
          DATA_RESTORED="false"
          if [ -d "${{ github.workspace }}/veiled-journeys/openlist-data" ]; then
            echo "Found existing data in 'veiled-journeys/openlist-data'. Restoring..."
            sudo rsync -av --delete ${{ github.workspace }}/veiled-journeys/openlist-data/ /opt/openlist/data/
            echo "Data restoration complete."
            DATA_RESTORED="true"
          else
            echo "No 'openlist-data' directory found in repository. Starting with a fresh instance."
            sudo mkdir -p /opt/openlist/data
          fi
          echo "data_restored=$DATA_RESTORED" >> $GITHUB_OUTPUT
          echo "Data restoration status: $DATA_RESTORED"
        env:
          OPENLIST_PASSWORD: ${{ secrets.OPENLIST_PASSWORD }}

      - name: Install Python dependencies
        run: |
          echo "Installing Python dependencies..."
          pip install --upgrade pip
          pip install requests tqdm py7zr webdavclient3 rarfile

      - name: Install megadl CLI tool
        run: |
          echo "Installing megatools (includes megadl)..."
          sudo apt update
          sudo apt install megatools -y
          echo "Verifying megadl installation..."
          megadl --version

      - name: Install Localtunnel (npm package)
        run: |
          echo "Installing localtunnel via npm..."
          npm install -g localtunnel
          echo "Verifying localtunnel installation..."
          lt --version || true # Use || true as --version might exit with 1 sometimes

      - name: Start OpenList and Conditionally Start Localtunnel
        env:
          OPENLIST_PASSWORD: ${{ secrets.OPENLIST_PASSWORD }}
        run: |
          echo "Starting OpenList in the background..."
          sudo /opt/openlist/openlist start &
          # 捕获 OpenList 进程ID以供后续清理
          echo "OPENLIST_PID=$!" >> $GITHUB_ENV
          echo "OpenList started with PID ${OPENLIST_PID:-<unknown>}."
          
          # 给 OpenList 启动留出时间
          sleep 10
          
          if [ "${{ steps.configure-openlist-data.outputs.data_restored }}" == "false" ]; then
            echo "OpenList数据未找到或未恢复。启动Localtunnel以进行潜在的手动设置/调试..."
            # 启动 localtunnel 并捕获其输出中的URL和进程ID
            # 2>&1 将 stderr 合并到 stdout，然后grep/sed从其中提取URL
            LOCALTUNNEL_OUTPUT=$(lt --port 5244 2>&1 &) # 以后台运行
            echo "$LOCALTUNNEL_OUTPUT" # 打印所有输出，以便调试
            
            # 提取 URL，并设置一个变量来存储它。这个可能需要根据实际输出格式调整。
            # LocalTunnel输出通常是 'your url is: https://<random-id>.loca.lt'
            LOCALTUNNEL_URL=$(echo "$LOCALTUNNEL_OUTPUT" | grep -o 'https://[^ ]*\.loca\.lt')
            
            echo "LOCALTUNNEL_URL=$LOCALTUNNEL_URL" >> $GITHUB_ENV # 存储URL以便后续输出
            echo "Localtunnel started with URL: $LOCALTUNNEL_URL"
            
            # 捕获 Localtunnel 进程ID
            echo "LOCALTUNNEL_PID=$(jobs -p | xargs basename | tail -n 1)" >> $GITHUB_ENV # 获取最新后台进程的PID
            echo "Localtunnel started with PID ${LOCALTUNNEL_PID:-<unknown>}."
            sleep 5 # 给隧道建立连接留出时间
          else
            echo "OpenList数据已恢复。跳过Localtunnel启动。"
          fi

      - name: Run Kemono Downloader
        env:
          OPENLIST_PASSWORD: ${{ secrets.OPENLIST_PASSWORD }}
        run: |
          echo "Running Kemono Downloader..."
          sleep 1
          echo "Kemono Downloader finished."

      - name: Manual Access Window (Optional)
        # 提供一个固定的等待窗口，无论隧道是否启动，都可以用于检查日志等
        run: |
          echo "保持工作流活跃，以便手动访问。请检查日志以获取OpenList/下载器输出。"
          echo "如果Localtunnel已启动，其访问URL为: ${{ env.LOCALTUNNEL_URL }}"
          # 将作业保持活跃2小时（7200秒）。您可以根据需要调整此持续时间。
          sleep 1600
          echo "手动访问窗口关闭。"

      - name: Stop Services and Backup Data
        if: always() # 确保此步骤即使在之前的步骤失败时也能运行
        run: |
          echo "Stopping services and backing up OpenList data..."
          
          # 如果 Localtunnel 已启动，则停止它
          if [ -n "${{ env.LOCALTUNNEL_PID }}" ]; then # 检查 LOCALTUNNEL_PID 是否已设置
            echo "Stopping Localtunnel (PID ${{ env.LOCALTUNNEL_PID }})..."
            kill ${{ env.LOCALTUNNEL_PID }} || true # 使用 kill 命令停止，|| true 防止命令失败导致整个步骤失败
          fi
          
          # 停止 OpenList 服务
          if [ -n "${{ env.OPENLIST_PID }}" ]; then # 检查 OPENLIST_PID 是否已设置
            echo "Stopping OpenList (PID ${{ env.OPENLIST_PID }})..."
            sudo kill ${{ env.OPENLIST_PID }} || sudo /opt/openlist/openlist stop || true
          else
            echo "OPENLIST_PID 未找到，尝试通过命令停止OpenList..."
            sudo /opt/openlist/openlist stop || true
          fi
          
          echo "Backing up OpenList data to the repository..."
          cd ${{ github.workspace }}/veiled-journeys
          sudo rsync -av --delete /opt/openlist/data/ ./openlist-data/
          
          echo "Fixing permissions for git..."
          sudo chown -R $(whoami):$(whoami) ./openlist-data/
          
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          if [[ -z $(git status --porcelain) ]]; then
            echo "OpenList数据没有变化。无需提交。"
          else
            echo "检测到变化。提交并推送到仓库..."
            git add openlist-data
            git commit -m "chore: Backup OpenList data from workflow run" -m "[skip ci]"
            git push
            echo "数据备份完成。"
          fi