name: Manual LobeChat Deploy

on:
  workflow_dispatch:
    inputs:
      commit_hash:
        description: 'Commit Hash to deploy (Git SHA)'
        required: true
        default: 'HEAD'

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Clone LobeChat Repository
        uses: actions/checkout@v4
        with:
          repository: lobehub/lobe-chat
          ref: main
          fetch-depth: 0

      - name: Checkout Specific Commit
        if: inputs.commit_hash != 'HEAD'
        run: git checkout ${{ inputs.commit_hash }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      # 修复 sudo 找不到 bun 的问题
      - name: Expose Bun to Root
        run: |
          BUN_PATH=$(which bun)
          sudo ln -s "$BUN_PATH" /usr/local/bin/bun

      - name: Install Vercel CLI
        run: npm install -g vercel

      - name: Install Project Dependencies
        run: bun install

      - name: Link Project & Pull Settings
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build Project (Local with Sudo)
        # 这里的修改：添加了忽略 Lint 和 Type Check 的环境变量
        run: |
          sudo NEXT_IGNORE_ESLINT_BUILD_ERRORS=true \
               NEXT_IGNORE_TYPE_CHECK_BUILD_ERRORS=true \
               VERCEL_FORCE_NO_BUILD_CACHE=1 \
               VERCEL_ORG_ID=${{ secrets.VERCEL_ORG_ID }} \
               VERCEL_PROJECT_ID=${{ secrets.VERCEL_PROJECT_ID }} \
               VERCEL_TOKEN=${{ secrets.VERCEL_TOKEN }} \
               vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy to Vercel
        run: |
          sudo VERCEL_ORG_ID=${{ secrets.VERCEL_ORG_ID }} \
               VERCEL_PROJECT_ID=${{ secrets.VERCEL_PROJECT_ID }} \
               VERCEL_TOKEN=${{ secrets.VERCEL_TOKEN }} \
               vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}