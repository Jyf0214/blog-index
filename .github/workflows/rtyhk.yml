name: Install Latest Alist, Check DB, Set Password, Run with Repo Config

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  install_and_run_job:
    runs-on: ubuntu-latest

    steps:
      # 步骤 1: 检出运行工作流的代码库
      - name: Checkout workflow repository
        uses: actions/checkout@v4

      # 步骤 2: 安装基础工具
      # 添加 sqlite3 用于数据库检查
      - name: Install base tools (curl, gpg, git, sqlite3)
        run: sudo apt-get update && sudo apt-get install -y curl gpg git sqlite3

      # 步骤 3: 安装 cloudflared
      - name: Create keyrings directory
        run: sudo mkdir -p --mode=0755 /usr/share/keyrings
      - name: Download Cloudflare GPG key
        run: curl -fsSL https://pkg.cloudflare.com/cloudflare-main.gpg | sudo gpg --dearmor --yes -o /usr/share/keyrings/cloudflare-main.gpg
      - name: Add Cloudflare APT repository
        run: echo "deb [signed-by=/usr/share/keyrings/cloudflare-main.gpg] https://pkg.cloudflare.com/cloudflared $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/cloudflared.list
      - name: Update package list and install cloudflared
        run: sudo apt-get update && sudo apt-get install -y cloudflared
      - name: Verify cloudflared installation
        run: cloudflared --version

      # 步骤 4: 克隆包含 Alist 配置的私有仓库
      - name: Clone private repository (veiled-journeys)
        env:
          PAT: ${{ secrets.PAT }}
        run: git clone https://x-access-token:${PAT}@github.com/Jyf0214/veiled-journeys.git

      # --- 新增步骤 5: 检查并可能替换损坏的 data.db ---
      - name: Check and potentially replace corrupted data.db
        run: |
          DB_FILE="./veiled-journeys/data/data.db"
          echo "Checking database file: $DB_FILE"

          if [ -f "$DB_FILE" ]; then
            echo "Database file exists. Checking integrity..."
            # PRAGMA integrity_check; 会输出 'ok' 或错误信息。我们只关心退出码。
            # > /dev/null 2>&1 将所有输出重定向，避免干扰日志，只检查退出状态。
            if sqlite3 "$DB_FILE" "PRAGMA integrity_check;" > /dev/null 2>&1; then
              echo "Database integrity check seems ok (command succeeded)."
            else
              # 如果命令失败（非0退出码），则认为文件损坏
              echo "Warning: Database integrity check failed (exit code $?). File might be corrupted."
              echo "Replacing corrupted database file by deleting it. Alist will create a new one."
              rm -f "$DB_FILE"
              if [ $? -eq 0 ]; then
                echo "Corrupted database file removed."
              else
                echo "Error: Failed to remove corrupted database file."
                # 可以选择在这里失败 Action，如果删除失败是严重问题
                # exit 1
              fi
            fi
          else
            echo "Database file does not exist. Alist will create a new one."
          fi

      # 步骤 6: 使用官方脚本安装最新 Alist 到 /opt/alist (现在是第 6 步)
      - name: Install Latest Alist using official script
        run: curl -fsSL "https://alist.nn.ci/v3.sh" | sudo bash -s install || true

      # 步骤 7: 验证 Alist 安装 (使用完整路径, 现在是第 7 步)
      - name: Verify Alist installation
        run: /opt/alist/alist version

      # 步骤 8: 安装 Python 依赖 (如果需要, 现在是第 8 步)
      - name: Install Python dependencies
        run: pip install -r veiled-journeys/requirements.txt

      # 步骤 9: 安装 Alist 可能需要的其他依赖 (如果需要, 现在是第 9 步)
      - name: Install image optimization tools
        run: sudo apt-get update && sudo apt-get install -y jpegoptim optipng

      # 步骤 10: 设置脚本执行权限 (现在是第 10 步)
      - name: Set script execution permission
        run: chmod +x veiled-journeys/process_loop.sh

      # 步骤 11: 启动 Cloudflared Tunnel (现在是第 11 步)
      - name: Start Cloudflared Tunnel in background
        working-directory: ./veiled-journeys
        run: |
          echo "Starting Cloudflared tunnel..."
          nohup cloudflared tunnel --config .cloudflared/config.yml run > cloudflared.log 2>&1 &
          sleep 5

      # 步骤 12: 从 Secret 设置 Alist 管理员密码 (现在是第 12 步)
      # 如果 data.db 被删除了，这个命令会初始化新的数据库并设置密码
      - name: Set Alist Admin Password from Secret
        env:
          ALIST_PASSWORD: ${{ secrets.ALIST_ADMIN_PASSWORD }}
        run: |
          echo "Setting Alist admin password..."
          if [ -z "$ALIST_PASSWORD" ]; then
            echo "Error: ALIST_ADMIN_PASSWORD secret is not set!"
            exit 1
          fi
          # --data 路径必须正确指向包含 config.json (和 data.db) 的目录
          /opt/alist/alist admin set "$ALIST_PASSWORD" --data ./veiled-journeys/data
          echo "Alist admin password set successfully (or database initialized if it was missing)."

      # 步骤 13: 启动 Alist 服务 (现在是第 13 步)
      - name: Start Alist server with repository config
        run: |
          echo "Starting Alist server using installed binary..."
          nohup /opt/alist/alist server --data ./veiled-journeys/data > ./veiled-journeys/alist.log 2>&1 &
          sleep 5

      # 步骤 14: (可选) 执行你的处理循环脚本 (现在是第 14 步)
      # - name: Execute processing loop
      #   working-directory: ./veiled-journeys
      #   run: ./process_loop.sh

      # 步骤 15: 检查服务状态或日志 (现在是第 15 步)
      - name: Check background process status and logs
        run: |
          echo "--- Cloudflared Status (ps) ---"
          ps aux | grep cloudflared || echo "Cloudflared process not found"
          echo "--- Alist Status (ps) ---"
          ps aux | grep '/opt/alist/alist server' || echo "Alist process not found"
          echo "--- Cloudflared Log ---"
          cat ./veiled-journeys/cloudflared.log || echo "Cloudflared log not found"
          echo "--- Alist Log ---"
          cat ./veiled-journeys/alist.log || echo "Alist log not found"
          echo "--- Testing Alist locally ---"
          curl --fail http://localhost:5244 || echo "Failed to connect to Alist locally on port 5244"

      # 步骤 16: 打印最终的当前工作目录 (现在是第 16 步)
      - name: Print Final Current Working Directory
        run: pwd
      # 步骤 15: 打印最终的当前工作目录 (现在是第 15 步, 并且移除了 sleep)
      - name: Print Final Current Working Directory
        run: sleep 20000

      - name: Check and Push
        run: |
           cd veiled-journeys
           git pull
           git add .
           git commit -m "Add feature X documentation"
           git push