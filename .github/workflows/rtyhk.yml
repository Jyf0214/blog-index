# .github/workflows/run_with_cloudflare.yml
name: Run OpenList + Kemono Downloader via Cloudflare Tunnel

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

jobs:
  openlist-kemono:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install OpenList
      run: |
        curl -fsSL "https://docs.openlist.team/v3.sh" -o v3.sh
        bash v3.sh install /opt/openlist

    - name: Configure OpenList
      run: |
        cd /opt/openlist
        ./openlist admin set "${{ secrets.OPENLIST_PASSWORD }}"
        if [ -d ../../openlist ]; then sudo cp -r ../../openlist/* data/; fi
      env:
        OPENLIST_PASSWORD: ${{ secrets.OPENLIST_PASSWORD }}

    - name: Start OpenList
      run: sudo /opt/openlist/openlist start

    - uses: AnimMouse/setup-cloudflared@v2

    - name: Establish Cloudflare Tunnel
      uses: AnimMouse/setup-cloudflared/tunnel@v2
      with:
        cloudflare_tunnel_credential: ${{ secrets.CLOUDFLARE_TUNNEL_CREDENTIAL }}
        cloudflare_tunnel_configuration: ${{ secrets.CLOUDFLARE_TUNNEL_CONFIGURATION }}
        cloudflare_tunnel_id: ${{ secrets.CLOUDFLARE_TUNNEL_ID }}
      id: tunnel

    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run Kemono Downloader
      env:
        OPENLIST_URL: https://your-tunnel-url.cloudflare.com
        OPENLIST_PASSWORD: ${{ secrets.OPENLIST_PASSWORD }}
      run: python kemono_downloader.py

    - name: Teardown Tunnel
      if: always()
      uses: AnimMouse/setup-cloudflared/shutdown@v2

    - name: Stop OpenList
      if: always()
      run: sudo /opt/openlist/openlist stop

    - name: Upload downloads
      uses: actions/upload-artifact@v4
      with:
        name: kemono-output
        path: ./output/
        compression-level: 0
        if-no-files-found: error
