name: Manual LobeChat Deploy

on:
  workflow_dispatch:
    inputs:
      commit_hash:
        description: 'Commit Hash to deploy (Git SHA)'
        required: true
        default: 'HEAD'

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. 克隆代码
      - name: Clone LobeChat Repository
        uses: actions/checkout@v4
        with:
          repository: lobehub/lobe-chat
          ref: main
          fetch-depth: 0

      # 2. 切换到指定 Commit
      - name: Checkout Specific Commit
        if: inputs.commit_hash != 'HEAD'
        run: git checkout ${{ inputs.commit_hash }}

      # ============ 新增步骤：设置 Node.js 22 ============
      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      # 3. 安装 Bun
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      # 4. 修复 Sudo 找不到 Bun 的问题
      - name: Expose Bun to Root
        run: |
          BUN_PATH=$(which bun)
          echo "Bun found at: $BUN_PATH"
          sudo ln -s "$BUN_PATH" /usr/local/bin/bun

      # 5. 安装 Vercel CLI (将使用 Node 22 环境安装)
      - name: Install Vercel CLI
        run: npm install -g vercel

      # 6. 安装项目依赖
      - name: Install Project Dependencies
        run: bun install

      # 7. 拉取 Vercel 项目配置
      - name: Link Project & Pull Settings
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      # 8. 本地构建 (Node 22 + Bun 环境)
      # 包含忽略 ESLint 和 TypeScript 错误的变量
      - name: Build Project (Local with Sudo)
        run: |
          sudo NEXT_IGNORE_ESLINT_BUILD_ERRORS=true \
               NEXT_IGNORE_TYPE_CHECK_BUILD_ERRORS=true \
               VERCEL_FORCE_NO_BUILD_CACHE=1 \
               VERCEL_ORG_ID=${{ secrets.VERCEL_ORG_ID }} \
               VERCEL_PROJECT_ID=${{ secrets.VERCEL_PROJECT_ID }} \
               VERCEL_TOKEN=${{ secrets.VERCEL_TOKEN }} \
               vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}

      # 9. 推入远程部署
      - name: Deploy to Vercel
        run: |
          sudo VERCEL_ORG_ID=${{ secrets.VERCEL_ORG_ID }} \
               VERCEL_PROJECT_ID=${{ secrets.VERCEL_PROJECT_ID }} \
               VERCEL_TOKEN=${{ secrets.VERCEL_TOKEN }} \
               vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}