name: Install Latest Alist, Set Password, Run with Repo Config

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  install_and_run_job:
    runs-on: ubuntu-latest

    steps:
      # 步骤 1: 检出运行工作流的代码库
      - name: Checkout workflow repository
        uses: actions/checkout@v4

      # 步骤 2: 安装基础工具
      - name: Install base tools (curl, gpg, git)
        run: sudo apt-get update && sudo apt-get install -y curl gpg git

      # 步骤 3: 安装 cloudflared
      - name: Create keyrings directory
        run: sudo mkdir -p --mode=0755 /usr/share/keyrings
      - name: Download Cloudflare GPG key
        run: curl -fsSL https://pkg.cloudflare.com/cloudflare-main.gpg | sudo gpg --dearmor --yes -o /usr/share/keyrings/cloudflare-main.gpg
      - name: Add Cloudflare APT repository
        run: echo "deb [signed-by=/usr/share/keyrings/cloudflare-main.gpg] https://pkg.cloudflare.com/cloudflared $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/cloudflared.list
      - name: Update package list and install cloudflared
        run: sudo apt-get update && sudo apt-get install -y cloudflared
      - name: Verify cloudflared installation
        run: cloudflared --version

      # 步骤 4: 克隆包含 Alist 配置的私有仓库
      - name: Clone private repository (veiled-journeys)
        env:
          PAT: ${{ secrets.PAT }}
        run: git clone https://x-access-token:${PAT}@github.com/Jyf0214/veiled-journeys.git

      # 步骤 5: 使用官方脚本安装最新 Alist 到 /opt/alist
      - name: Install Latest Alist using official script
        run: curl -fsSL "https://alist.nn.ci/v3.sh" | sudo bash -s install || true

      # 步骤 6: 验证 Alist 安装 (使用完整路径)
      - name: Verify Alist installation
        run: /opt/alist/alist version

      # 步骤 7: 安装 Python 依赖 (如果需要)
      - name: Install Python dependencies
        run: pip install -r veiled-journeys/requirements.txt

      # 步骤 8: 安装 Alist 可能需要的其他依赖 (如果需要)
      - name: Install image optimization tools
        run: sudo apt-get update && sudo apt-get install -y jpegoptim optipng

      # 步骤 9: 设置脚本执行权限
      - name: Set script execution permission
        run: chmod +x veiled-journeys/process_loop.sh

      # 步骤 10: 启动 Cloudflared Tunnel
      - name: Start Cloudflared Tunnel in background
        working-directory: ./veiled-journeys
        run: |
          echo "Starting Cloudflared tunnel..."
          nohup cloudflared tunnel --config .cloudflared/config.yml run > cloudflared.log 2>&1 &
          sleep 5

      # --- 新增步骤 11: 从 Secret 设置 Alist 管理员密码 ---
      - name: Set Alist Admin Password from Secret
        env:
          # 将 Secret 值传递给环境变量，更安全且方便在 run 块中使用
          ALIST_PASSWORD: ${{ secrets.ALIST_ADMIN_PASSWORD }}
        run: |
          echo "Setting Alist admin password..."
          # 检查 Secret 是否已设置
          if [ -z "$ALIST_PASSWORD" ]; then
            echo "Error: ALIST_ADMIN_PASSWORD secret is not set!"
            exit 1
          fi
          # 使用完整路径执行命令，并指定 data 目录
          # 这个 --data 路径必须和下一步启动 Alist 时使用的 --data 路径完全一致！
          /opt/alist/alist admin set "$ALIST_PASSWORD" --data ./veiled-journeys/data
          echo "Alist admin password set successfully."

      # 步骤 12: 启动 Alist 服务 (现在是第 12 步)
      - name: Start Alist server with repository config
        run: |
          echo "Starting Alist server using installed binary..."
          # 使用完整路径 /opt/alist/alist
          # 这个 --data 路径必须和上一步设置密码时使用的 --data 路径完全一致！
          nohup /opt/alist/alist server --data ./veiled-journeys/data > ./veiled-journeys/alist.log 2>&1 &
          sleep 5

      # 步骤 13: (可选) 执行你的处理循环脚本 (现在是第 13 步)
      # - name: Execute processing loop
      #   working-directory: ./veiled-journeys
      #   run: ./process_loop.sh

      # 步骤 14: 检查服务状态或日志 (现在是第 14 步)
      - name: Check background process status and logs
        run: |
          echo "--- Cloudflared Status (ps) ---"
          ps aux | grep cloudflared || echo "Cloudflared process not found"
          echo "--- Alist Status (ps) ---"
          ps aux | grep '/opt/alist/alist server' || echo "Alist process not found"
          echo "--- Cloudflared Log ---"
          cat ./veiled-journeys/cloudflared.log || echo "Cloudflared log not found"
          echo "--- Alist Log ---"
          cat ./veiled-journeys/alist.log || echo "Alist log not found"
          echo "--- Testing Alist locally ---"
          curl --fail http://localhost:5244 || echo "Failed to connect to Alist locally on port 5244"

      # 步骤 15: 打印最终的当前工作目录 (现在是第 15 步, 并且移除了 sleep)
      - name: Print Final Current Working Directory
        run: pwd