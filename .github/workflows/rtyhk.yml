name: Manual LobeChat Deploy

on:
  workflow_dispatch:
    inputs:
      commit_hash:
        description: 'Commit Hash to deploy (Git SHA)'
        required: true
        default: 'HEAD'

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Clone LobeChat Repository
        uses: actions/checkout@v4
        with:
          repository: lobehub/lobe-chat
          ref: main
          fetch-depth: 0

      - name: Checkout Specific Commit
        if: inputs.commit_hash != 'HEAD'
        run: git checkout ${{ inputs.commit_hash }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      # ============ 新增步骤：修复 Sudo 找不到 Bun 的问题 ============
      - name: Expose Bun to Root
        run: |
          # 找到当前用户的 bun 路径
          BUN_PATH=$(which bun)
          echo "Bun found at: $BUN_PATH"
          # 软链接到 /usr/local/bin 让 sudo 也能访问
          sudo ln -s "$BUN_PATH" /usr/local/bin/bun

      - name: Install Vercel CLI
        run: npm install -g vercel

      # 提前安装依赖，虽然 Vercel build 可能会再次检查，但可以确保 node_modules 存在
      - name: Install Project Dependencies
        run: bun install

      - name: Link Project & Pull Settings
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build Project (Local with Sudo)
        # 即使 sudo 找到了 bun，Vercel 内部可能需要 HOME 目录来写入缓存或配置
        # 为了保险，我们在 sudo 命令中同时修正 PATH 或使用链接后的 bun
        run: |
          sudo VERCEL_FORCE_NO_BUILD_CACHE=1 \
               VERCEL_ORG_ID=${{ secrets.VERCEL_ORG_ID }} \
               VERCEL_PROJECT_ID=${{ secrets.VERCEL_PROJECT_ID }} \
               VERCEL_TOKEN=${{ secrets.VERCEL_TOKEN }} \
               vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy to Vercel
        run: |
          sudo VERCEL_ORG_ID=${{ secrets.VERCEL_ORG_ID }} \
               VERCEL_PROJECT_ID=${{ secrets.VERCEL_PROJECT_ID }} \
               VERCEL_TOKEN=${{ secrets.VERCEL_TOKEN }} \
               vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}