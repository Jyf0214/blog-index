name: Manual LobeChat Deploy

on:
  workflow_dispatch:
    inputs:
      commit_hash:
        description: 'Commit Hash to deploy (Git SHA)'
        required: true
        default: 'HEAD'

# 1. 在这里定义全局变量，普通的步骤都能读取到
env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Clone LobeChat Repository
        uses: actions/checkout@v4
        with:
          repository: lobehub/lobe-chat
          ref: main
          fetch-depth: 0

      - name: Checkout Specific Commit
        if: inputs.commit_hash != 'HEAD'
        run: git checkout ${{ inputs.commit_hash }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install Vercel CLI
        run: npm install -g vercel

      - name: Install Project Dependencies
        run: bun install

      # ============ 修改重点 ============
      # 2. 使用 vercel pull 替代 env pull
      # 这会下载 project.json 并链接项目，解决 "No Project Settings found" 错误
      # 注意：因为已经在全局 env 定义了 ORG_ID 和 PROJECT_ID，这里不需要重复传参
      - name: Link Project & Pull Settings
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      # 3. 使用 sudo 进行构建
      # 必须手动显式传递环境变量，因为 sudo 默认不继承当前用户的环境变量
      - name: Build Project (Local with Sudo)
        run: |
          sudo VERCEL_FORCE_NO_BUILD_CACHE=1 \
               VERCEL_ORG_ID=${{ secrets.VERCEL_ORG_ID }} \
               VERCEL_PROJECT_ID=${{ secrets.VERCEL_PROJECT_ID }} \
               VERCEL_TOKEN=${{ secrets.VERCEL_TOKEN }} \
               vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}

      # 4. 推入远程部署
      # 同样需要 sudo 权限读取上一步生成的 .vercel/output 目录
      - name: Deploy to Vercel
        run: |
          sudo VERCEL_ORG_ID=${{ secrets.VERCEL_ORG_ID }} \
               VERCEL_PROJECT_ID=${{ secrets.VERCEL_PROJECT_ID }} \
               VERCEL_TOKEN=${{ secrets.VERCEL_TOKEN }} \
               vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}