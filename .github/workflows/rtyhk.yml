name: Install Latest Alist, Run with Repo Config

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  install_and_run_job:
    runs-on: ubuntu-latest

    steps:
      # 步骤 1: 检出运行工作流的代码库 (如果需要)
      - name: Checkout workflow repository
        uses: actions/checkout@v4

      # 步骤 2: 安装基础工具
      - name: Install base tools (curl, gpg, git)
        run: sudo apt-get update && sudo apt-get install -y curl gpg git

      # 步骤 3: 安装 cloudflared
      - name: Create keyrings directory
        run: sudo mkdir -p --mode=0755 /usr/share/keyrings
      - name: Download Cloudflare GPG key
        run: curl -fsSL https://pkg.cloudflare.com/cloudflare-main.gpg | sudo gpg --dearmor --yes -o /usr/share/keyrings/cloudflare-main.gpg
      - name: Add Cloudflare APT repository
        run: echo "deb [signed-by=/usr/share/keyrings/cloudflare-main.gpg] https://pkg.cloudflare.com/cloudflared $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/cloudflared.list
      - name: Update package list and install cloudflared
        run: sudo apt-get update && sudo apt-get install -y cloudflared
      - name: Verify cloudflared installation
        run: cloudflared --version

      # 步骤 4: 克隆包含 Alist 配置的私有仓库
      - name: Clone private repository (veiled-journeys)
        env:
          PAT: ${{ secrets.PAT }}
        run: git clone https://x-access-token:${PAT}@github.com/Jyf0214/veiled-journeys.git

      # 步骤 5: 使用官方脚本安装最新 Alist 到系统路径
      - name: Install Latest Alist using official script
        run: |
          curl -fsSL "https://alist.nn.ci/v3.sh" | sudo bash -s install
          # 脚本会将最新的 alist 安装到 PATH, 如 /usr/local/bin/alist

      # 步骤 6: 验证 Alist 安装 (可选)
      - name: Verify Alist installation
        run: alist version # 调用系统安装的 alist

      # 步骤 7: 安装 Python 依赖 (如果需要)
      - name: Install Python dependencies
        run: pip install -r veiled-journeys/requirements.txt

      # 步骤 8: 安装 Alist 可能需要的其他依赖 (如果需要)
      - name: Install image optimization tools
        run: sudo apt-get update && sudo apt-get install -y jpegoptim optipng

      # 步骤 9: 设置脚本执行权限 (不再需要处理 alist 文件)
      - name: Set script execution permission
        run: chmod +x veiled-journeys/process_loop.sh

      # 步骤 10: 启动 Cloudflared Tunnel
      # 使用 veiled-journeys/.cloudflared/ 中的配置
      - name: Start Cloudflared Tunnel in background
        working-directory: ./veiled-journeys
        run: |
          echo "Starting Cloudflared tunnel..."
          nohup cloudflared tunnel --config .cloudflared/config.yml run > cloudflared.log 2>&1 &
          sleep 5

      # 步骤 11: 启动 Alist 服务 (使用系统安装的最新alist，但指向仓库中的配置)
      - name: Start Alist server with repository config
        run: |
          echo "Starting Alist server using system binary..."
          # 使用 --data 指向克隆下来的 veiled-journeys 目录
          # Alist 会在此目录查找 config.json 和 data.db
          nohup alist server --data ./veiled-journeys > ./veiled-journeys/alist.log 2>&1 &
          # 如果你的配置文件在 veiled-journeys/data/ 下，请使用 --data ./veiled-journeys/data
          sleep 5

      # 步骤 12: (可选) 执行你的处理循环脚本
      # - name: Execute processing loop
      #   working-directory: ./veiled-journeys
      #   run: ./process_loop.sh

      # 步骤 13: 检查服务状态或日志
      - name: Check background process status and logs
        run: |
          echo "--- Cloudflared Status (ps) ---"
          ps aux | grep cloudflared || echo "Cloudflared process not found"
          echo "--- Alist Status (ps) ---"
          # 检查系统alist进程，注意命令可能不含'./'
          ps aux | grep -w 'alist server' || echo "Alist process not found"
          echo "--- Cloudflared Log ---"
          cat ./veiled-journeys/cloudflared.log || echo "Cloudflared log not found"
          echo "--- Alist Log ---"
          cat ./veiled-journeys/alist.log || echo "Alist log not found"
          echo "--- Testing Alist locally ---"
          curl --fail http://localhost:5244 || echo "Failed to connect to Alist locally on port 5244"

      # 步骤 14: 打印最终的当前工作目录
      - name: Print Final Current Working Directory
        run: pwd