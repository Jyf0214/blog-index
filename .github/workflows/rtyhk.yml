name: Manual LobeChat Deploy

on:
  workflow_dispatch:
    inputs:
      commit_hash:
        description: 'Commit Hash to deploy (Git SHA)'
        required: true
        default: 'HEAD'

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Clone LobeChat Repository
        uses: actions/checkout@v4
        with:
          repository: lobehub/lobe-chat
          ref: main
          fetch-depth: 0

      - name: Checkout Specific Commit
        if: inputs.commit_hash != 'HEAD'
        run: git checkout ${{ inputs.commit_hash }}

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install Vercel CLI
        run: npm install -g vercel

      # ============ 关键修复步骤 ============
      # 将 Node, Bun, Vercel 全部链接到系统目录
      # 这样 sudo 既能找到 vercel 命令，也能用正确的 node 版本运行它
      - name: Expose Tools to Root
        run: |
          # 1. 链接 Node.js (使用 -sf 强制覆盖系统可能自带的旧版链接)
          NODE_PATH=$(which node)
          echo "Linking Node from: $NODE_PATH"
          sudo ln -sf "$NODE_PATH" /usr/local/bin/node

          # 2. 链接 Bun
          BUN_PATH=$(which bun)
          echo "Linking Bun from: $BUN_PATH"
          sudo ln -sf "$BUN_PATH" /usr/local/bin/bun

          # 3. 链接 Vercel
          VERCEL_PATH=$(which vercel)
          echo "Linking Vercel from: $VERCEL_PATH"
          sudo ln -sf "$VERCEL_PATH" /usr/local/bin/vercel

      - name: Install Project Dependencies
        run: bun install

      - name: Link Project & Pull Settings
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build Project (Local with Sudo)
        # 现在 sudo 可以找到 vercel 和 node 了
        run: |
          sudo NEXT_IGNORE_ESLINT_BUILD_ERRORS=true \
               NEXT_IGNORE_TYPE_CHECK_BUILD_ERRORS=true \
               VERCEL_FORCE_NO_BUILD_CACHE=1 \
               VERCEL_ORG_ID=${{ secrets.VERCEL_ORG_ID }} \
               VERCEL_PROJECT_ID=${{ secrets.VERCEL_PROJECT_ID }} \
               VERCEL_TOKEN=${{ secrets.VERCEL_TOKEN }} \
               vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy to Vercel
        run: |
          sudo VERCEL_ORG_ID=${{ secrets.VERCEL_ORG_ID }} \
               VERCEL_PROJECT_ID=${{ secrets.VERCEL_PROJECT_ID }} \
               VERCEL_TOKEN=${{ secrets.VERCEL_TOKEN }} \
               vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}