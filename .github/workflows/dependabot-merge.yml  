name: Dependabot PR Auto-Merge

on:
  # 监听PR事件
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review

jobs:
  auto-merge-dependabot-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check if PR is from Dependabot
        id: check_dependabot
        run: |
          # 获取PR的作者信息
          PR_AUTHOR=$(jq -r '.user.login' < "${{ github.event.pull_request.head.repo.owner.login }}")
          echo "PR_AUTHOR=${PR_AUTHOR}" >> $GITHUB_ENV

      - name: Check PR status and merge/close
        run: |
          # 检查PR是否由Dependabot创建
          if [[ "${{ env.PR_AUTHOR }}" == "dependabot[bot]" ]]; then
            # 获取PR的状态
            PR_STATUS=$(gh pr view ${{ github.event.pull_request.number }} --json statusCheckRollup --jq '.statusCheckRollup.state')
            echo "PR status: ${PR_STATUS}"

            # 根据状态决定合并或关闭
            if [[ "${PR_STATUS}" == "EXPECTED" ]]; then
              echo "PR passed all checks. Merging..."
              gh pr merge ${{ github.event.pull_request.number }} --auto --squash --merge
            else
              echo "PR failed checks. Closing..."
              gh pr close ${{ github.event.pull_request.number }} --comment "This PR failed checks and is being closed automatically."
            fi
          else
            echo "PR is not from Dependabot. Skipping."
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
